# Архитектура проекта

## Введение

Данный документ описывает архитектуру образовательного Telegram-бота по истории России. Он предоставляет обзор ключевых компонентов системы, их взаимодействия и используемые технологические решения.

## Общая архитектура

Проект реализован с использованием модульного подхода и следует принципам объектно-ориентированного программирования. Архитектура построена на основе паттернов проектирования, обеспечивающих гибкость, расширяемость и тестируемость кода.

### Диаграмма компонентов

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Telegram API   │◄───►│    Bot Core     │◄───►│   Gemini API    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               ▲
                               │
                 ┌─────────────┴─────────────┐
                 │                           │
        ┌────────▼────────┐        ┌────────▼────────┐
        │  CommandHandlers │        │  ContentService │
        └─────────────────┘        └─────────────────┘
                 ▲                           ▲
                 │                           │
      ┌──────────┴──────────┐     ┌─────────┴─────────┐
      │                     │     │                   │
┌─────▼─────┐         ┌────▼────┐ │ ┌───────────┐    │
│UIManager  │         │APIClient │ │ │APICache   │    │
└───────────┘         └─────────┘ │ └───────────┘    │
      ▲                    ▲      │       ▲          │
      │                    │      │       │          │
      └────────┬───────────┘      └────┬──┘          │
               │                       │             │
        ┌──────▼──────┐         ┌─────▼─────┐┌────────▼────────┐
        │MessageManager│         │TextCache  ││AnalyticsService│
        └─────────────┘         └───────────┘└─────────────────┘
               ▲                                     ▲
               │                                     │
        ┌──────▼──────┐                     ┌────────▼────────┐
        │Logger       │                     │HistoryMapService│
        └─────────────┘                     └─────────────────┘
                                                   ▲
                                                   │
                                            ┌──────▼─────┐
                                            │  WebServer │
                                            └────────────┘
```

## Основные компоненты

### 1. Bot Core (src/bot.py)

Центральный компонент системы, отвечающий за основную логику взаимодействия с Telegram API.

**Ответственности:**
- Инициализация и настройка бота
- Регистрация обработчиков команд
- Обработка входящих сообщений
- Управление жизненным циклом бота

### 2. Command Handlers (src/handlers.py)

Модуль, содержащий обработчики команд и входящих сообщений пользователя.

**Ответственности:**
- Обработка стандартных команд (/start, /help, и т.д.)
- Управление диалоговыми состояниями
- Маршрутизация запросов пользователя к соответствующим сервисам
- Формирование ответов пользователю

### 3. API Client (src/api_client.py)

Клиент для взаимодействия с внешними API (Google Gemini API).

**Ответственности:**
- Формирование запросов к API
- Обработка ответов API
- Управление ошибками и повторами запросов
- Оптимизация использования API-ключей

### 4. Content Service (src/content_service.py)

Сервис для управления образовательным контентом.

**Ответственности:**
- Получение информации по историческим темам
- Структурирование и форматирование контента
- Управление кэшированием контента
- Проверка релевантности запросов

### 5. Test Service (src/test_service.py)

Сервис для генерации и проверки тестов.

**Ответственности:**
- Генерация тестовых вопросов по заданной теме
- Проверка ответов пользователя
- Формирование образовательной обратной связи
- Анализ результатов тестирования

### 6. UI Manager (src/ui_manager.py)

Компонент для управления пользовательским интерфейсом.

**Ответственности:**
- Создание клавиатур и кнопок
- Форматирование текстовых сообщений
- Управление визуальными элементами
- Адаптация интерфейса для разных типов пользователей

### 7. Admin Panel (src/admin_panel.py)

Компонент для управления административными функциями бота.

**Ответственности:**
- Аутентификация администраторов
- Предоставление интерфейса управления
- Обработка административных команд
- Управление настройками бота

### 8. Analytics Service (src/analytics.py)

Сервис для сбора и анализа статистики использования бота.

**Ответственности:**
- Сбор метрик использования
- Анализ популярности тем и тестов
- Отслеживание активности пользователей
- Формирование аналитических отчетов

### 9. History Map Service (src/history_map.py)

Сервис для работы с историческими картами и визуализациями.

**Ответственности:**
- Генерация интерактивных исторических карт
- Визуализация исторических периодов
- Управление временными линиями
- Интеграция географических данных

### 10. Web Server (src/web_server.py)

Компонент для предоставления веб-интерфейса администрирования.

**Ответственности:**
- Предоставление административного веб-интерфейса
- Визуализация статистики и логов
- Управление ботом через веб-интерфейс
- Обеспечение безопасности доступа

## Используемые паттерны проектирования

В архитектуре проекта используются следующие паттерны проектирования:

1. **Factory** (BotFactory в src/factory.py) - для создания и настройки экземпляра бота с необходимой конфигурацией.

2. **Service Locator** (ServiceContainer в src/service_container.py) - для централизованного управления сервисами и их зависимостями.

3. **Strategy** (различные реализации в src/api_client.py) - для реализации различных алгоритмов взаимодействия с API.

4. **Singleton** (Logger в src/logger.py) - для компонентов, которые должны существовать в единственном экземпляре.

5. **Command** (в обработчиках команд) - для инкапсуляции запросов пользователя в виде объектов.

6. **Observer** (в модуле src/analytics.py) - для оповещения компонентов о событиях и сбора статистики.

7. **Template Method** (в базовых классах сервисов) - для определения скелета алгоритма, делегируя реализацию некоторых шагов подклассам.

## Система кэширования

Для оптимизации производительности и снижения нагрузки на внешние API в проекте реализована многоуровневая система кэширования:

1. **API Cache** (src/api_cache.py) - кэширует ответы внешних API для снижения количества запросов.

2. **Text Cache** (src/text_cache_service.py) - кэширует сгенерированный текстовый контент для быстрого доступа.

3. **Distributed Cache** (src/distributed_cache.py) - опциональный компонент для распределенного кэширования в случае высокой нагрузки.

## Система обработки ошибок

Проект включает комплексную систему обработки ошибок и логирования:

1. **Exception Handling** - каждый модуль содержит механизмы обработки ожидаемых исключений.

2. **Logging** (src/logger.py) - централизованная система логирования с различными уровнями детализации.

3. **Fallback Mechanisms** - механизмы восстановления и автоматического перезапуска при критических ошибках.

## Механизмы масштабирования

Архитектура проекта предусматривает несколько механизмов масштабирования для обработки растущей нагрузки:

1. **API Key Rotation** - ротация API-ключей для равномерного распределения запросов и соблюдения лимитов.

2. **Task Queue** (src/task_queue.py) - очередь для асинхронной обработки длительных операций.

3. **Telegram Queue** (src/telegram_queue.py) - специализированная очередь для управления сообщениями Telegram с учетом ограничений API.

4. **Performance Monitor** (src/performance_monitor.py) - мониторинг производительности и автоматическая оптимизация работы компонентов.

## Заключение

Архитектура проекта обеспечивает гибкость, расширяемость и надежность системы. Модульный подход позволяет легко добавлять новые функции и компоненты без значительных изменений существующего кода. Использование паттернов проектирования и принципов SOLID делает код более поддерживаемым и тестируемым.