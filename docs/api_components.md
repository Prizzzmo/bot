
# Документация по API и компонентам

## API клиент (APIClient)

### Описание
`APIClient` обеспечивает взаимодействие с Google Gemini API для генерации исторического контента.

### Основные методы
- `call_api(prompt, temperature, max_tokens, use_cache, system_prompt)` - Основной метод для запросов к API
- `validate_historical_topic(topic)` - Проверяет, относится ли тема к истории России
- `get_historical_info(topic)` - Получает структурированную информацию по теме
- `generate_historical_test(topic)` - Генерирует тестовые задания

### Параметры конфигурации
- `temperature` (0.1-1.0) - Контролирует креативность ответов (низкие значения для фактов)
- `max_tokens` - Максимальная длина ответа

## Кэширование (APICache)

### Описание
`APICache` реализует механизм кэширования API запросов для оптимизации производительности.

### Основные методы
- `get(key)` - Получение значения из кэша
- `set(key, value, ttl)` - Установка значения в кэш с временем жизни
- `remove(key)` - Удаление элемента из кэша
- `clear()` - Очистка всего кэша
- `get_stats()` - Получение статистики использования

### Особенности
- Персистентное хранение в JSON-файле
- Автоматическая очистка истекших элементов
- Политика вытеснения LRU (Least Recently Used)

## Логирование (Logger)

### Описание
`Logger` предоставляет расширенную систему логирования с множеством функций.

### Основные методы
- `info(message)` - Логирование информационных сообщений
- `warning(message)` - Логирование предупреждений
- `error(message)` - Логирование ошибок
- `debug(message)` - Логирование отладочных сообщений
- `log_error(error, additional_info)` - Расширенное логирование исключений
- `get_logs(level, start_date, end_date, limit)` - Получение логов с фильтрацией

### Особенности
- Буферизация для оптимизации I/O операций
- Ротация логов по размеру файла
- Фильтрация и форматирование

## Сервис тестирования (TestService)

### Описание
`TestService` управляет генерацией и обработкой тестов по истории.

### Основные методы
- `generate_test(topic)` - Генерирует тестовые вопросы по теме
- `format_question_text(question_text)` - Форматирует текст вопроса для отображения
- `parse_correct_answer(question_text)` - Извлекает правильный ответ
- `recommend_similar_topics(current_topic, api_client)` - Рекомендует похожие темы

## Кэширование текстов (TextCacheService)

### Описание
`TextCacheService` кэширует сгенерированные тексты для повторного использования.

### Основные методы
- `get_text(topic, text_type)` - Получение текста из кэша
- `save_text(topic, text_type, text)` - Сохранение текста в кэш
- `clear_cache(topic_filter)` - Очистка кэша по фильтру
- `get_stats()` - Получение статистики использования

## Диаграмма взаимодействия компонентов

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Telegram API   │◄───►│    Bot Core     │◄───►│   Gemini API    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               ▲
                               │
                 ┌─────────────┴─────────────┐
                 │                           │
        ┌────────▼────────┐        ┌────────▼────────┐
        │  CommandHandlers │        │  ContentService │
        └─────────────────┘        └─────────────────┘
                 ▲                           ▲
                 │                           │
      ┌──────────┴──────────┐     ┌─────────┴─────────┐
      │    StateManager     │     │    TestService    │
      └─────────────────────┘     └───────────────────┘
```
