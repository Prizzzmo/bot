
# Руководство по разработке

## Введение

Данное руководство предназначено для разработчиков, которые хотят участвовать в развитии образовательного Telegram-бота по истории России. Документ описывает архитектуру проекта, основные компоненты, соглашения по коду и процесс разработки.

## Архитектура проекта

Проект реализован на основе модульной архитектуры с четким разделением ответственности:

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Telegram API   │◄───►│    Bot Core     │◄───►│   Gemini API    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               ▲
                               │
                 ┌─────────────┴─────────────┐
                 │                           │
        ┌────────▼────────┐        ┌────────▼────────┐
        │  CommandHandlers │        │  ContentService │
        └─────────────────┘        └─────────────────┘
```

### Основные компоненты системы:

1. **Bot Core** (`src/bot.py`) - Ядро бота, управляющее взаимодействием с Telegram API
2. **API Client** (`src/api_client.py`) - Клиент для работы с Google Gemini API
3. **Command Handlers** (`src/handlers.py`) - Обработчики команд пользователя
4. **Content Service** (`src/content_service.py`) - Сервис для работы с историческим контентом
5. **Test Service** (`src/test_service.py`) - Сервис для генерации и проверки тестов
6. **Conversation Service** (`src/conversation_service.py`) - Сервис для обработки бесед с пользователем
7. **UI Manager** (`src/ui_manager.py`) - Компонент для управления пользовательским интерфейсом
8. **Analytics Service** (`src/analytics.py`) - Сервис для сбора и анализа статистики
9. **History Map** (`src/history_map.py`) - Сервис для работы с историческими картами
10. **Logger** (`src/logger.py`) - Система логирования
11. **Admin Panel** (`src/admin_panel.py`) - Панель управления для администраторов

## Соглашения по коду

### Структура файлов

- `src/` - исходный код проекта
- `docs/` - документация
- `tests/` - тесты
- `history_db_generator/` - генератор базы данных исторических событий
- `logs/` - логи работы бота
- `backups/` - резервные копии данных
- `webapp/` - веб-интерфейс администрирования

### Стиль кода

1. **Именование:**
   - Классы: `CamelCase` (например, `APIClient`)
   - Функции и методы: `snake_case` (например, `get_historical_info`)
   - Константы: `UPPER_CASE` (например, `MAX_RETRY_COUNT`)

2. **Документирование:**
   - Каждый класс и метод должен иметь docstring в формате Google Style
   - Комментарии должны объяснять "почему", а не "что"

3. **Обработка ошибок:**
   - Используйте конструкции try-except для обработки исключений
   - Логируйте все исключения с достаточным контекстом

### Правила работы с Git

1. **Ветвление:**
   - `main` - стабильная ветка релизов
   - `develop` - ветка разработки
   - `feature/feature-name` - ветки для новых функций
   - `bugfix/bug-description` - ветки для исправления ошибок

2. **Коммиты:**
   - Используйте осмысленные сообщения коммитов
   - Придерживайтесь формата: `[Тип изменения] Краткое описание` (например, `[Feature] Add test generator`)

3. **Pull Requests:**
   - Создавайте отдельные PR для каждой функции или исправления
   - Включайте описание изменений и тестирования
   - Запрашивайте код-ревью у других разработчиков

## База данных исторических событий

### Структура данных

База данных исторических событий хранится в формате JSON и содержит следующие поля:
- `name` - название исторического события
- `description` - подробное описание события
- `year` - год события
- `category` - категория события
- `importance` - важность события (от 1 до 5)
- `created_at` - время создания записи
- `updated_at` - время последнего обновления записи

### Обновление базы данных

Для обновления базы данных используется скрипт `run_gemini_generator.py`, который:
1. Инициализирует необходимые директории
2. Проверяет доступность API ключей Gemini
3. Генерирует список исторических тем России
4. Для каждой темы собирает детальную информацию о событиях
5. Сохраняет результаты в JSON файл

## Работа с админ-панелью

Админ-панель предоставляет интерфейс для управления ботом. Основные компоненты:

### Аутентификация и авторизация

Управление осуществляется через класс `AdminPanel` в файле `src/admin_panel.py`:
- Метод `is_admin()` проверяет права доступа пользователя
- Метод `is_super_admin()` проверяет наличие прав супер-администратора

### Добавление новых функций админ-панели

Для добавления новой функции в админ-панель:

1. Добавьте кнопку в метод `handle_admin_command()`:
```python
keyboard.append([InlineKeyboardButton("Название функции", callback_data='admin_new_function')])
```

2. Добавьте обработчик в метод `handle_admin_callback()`:
```python
elif action == 'admin_new_function' and self.is_super_admin(user_id):
    self._show_new_function(query, context)
```

3. Создайте метод для отображения интерфейса функции:
```python
def _show_new_function(self, query, context):
    # Логика отображения функции
    pass
```

4. При необходимости добавьте обработчики для действий внутри функции:
```python
def _handle_new_function_action(self, query, context, action):
    # Логика обработки действий
    pass
```

## Процесс разработки

### Настройка окружения разработки

1. Клонируйте репозиторий
2. Установите зависимости из `requirements.txt`
3. Создайте файл `.env` с необходимыми API ключами (см. `.env.example`)

### Запуск бота для разработки

```bash
python main.py
```

Для запуска веб-интерфейса:

```bash
python run_webapp.py
```

### Тестирование

Запуск всех тестов:

```bash
python -m pytest tests/
```

Запуск конкретного теста:

```bash
python -m pytest tests/test_api_client.py
```

## Интеграция с Gemini API

Проект использует Google Gemini API для генерации контента. API клиент (`src/api_client.py`) предоставляет следующие основные методы:

- `call_api()` - базовый метод для вызова Gemini API
- `ask_grok()` - упрощенный метод для получения текстового ответа
- `validate_historical_topic()` - проверка, относится ли тема к истории России
- `get_historical_info()` - получение информации по исторической теме
- `generate_historical_test()` - генерация теста по исторической теме

### Управление API-ключами

API-ключи хранятся в `gemini_api_keys.py` и используются в ротации для оптимизации использования квот:

```python
# Пример содержимого файла gemini_api_keys.py
GEMINI_API_KEYS = [
    "key1",
    "key2",
    "key3"
]

def get_key_by_index(index=0):
    if index < 0 or index >= len(GEMINI_API_KEYS):
        return GEMINI_API_KEYS[0]
    return GEMINI_API_KEYS[index]
```

## Кэширование

Для оптимизации запросов к API используется система кэширования (`src/api_cache.py`). Основные функции:

- Кэширование запросов к Gemini API
- Управление временем жизни кэша (TTL)
- Очистка устаревших записей кэша

## Система логирования

Проект использует модульную систему логирования (`src/logger.py`), которая:

- Записывает логи в файл и консоль
- Поддерживает разные уровни логирования
- Сохраняет контекст ошибок для отладки

## Рекомендации по разработке новых функций

1. **Создание новой команды:**
   - Добавьте обработчик в `handlers.py`
   - Зарегистрируйте команду в диспетчере команд в `bot.py`

2. **Расширение исторической базы данных:**
   - Модифицируйте генератор в `history_db_generator/generator.py`
   - Запустите обновление базы через `run_gemini_generator.py`

3. **Добавление интеграции с новым API:**
   - Создайте новый клиент в стиле `api_client.py`
   - Зарегистрируйте клиент в `service_container.py`

4. **Расширение функционала админ-панели:**
   - Добавьте новую функцию в `admin_panel.py`
   - Обновите обработчики в методе `handle_admin_callback()`
   - При необходимости создайте новые методы для управления

## Резервное копирование и восстановление данных

Система автоматически создает резервные копии данных в директории `backups/`. Для ручного создания резервной копии используйте:

```bash
python data_migration.py --backup
```

Для восстановления из резервной копии:

```bash
python data_migration.py --restore <path_to_backup>
```

## Мониторинг и аналитика

Система собирает аналитические данные о работе бота, которые доступны через:

1. Логи в директории `logs/`
2. Веб-интерфейс аналитики (если запущен через `run_webapp.py`)
3. Административную панель бота (команда `/admin` и раздел "Статистика")

## Обработка API-ключей

Для безопасной работы с API-ключами:

1. Не храните ключи в коде
2. Используйте переменные окружения или отдельный конфигурационный файл
3. Не включайте файлы с ключами в систему контроля версий

## Производительность и оптимизация

Для обеспечения высокой производительности бота:

1. Используйте кэширование для часто запрашиваемой информации
2. Оптимизируйте запросы к внешним API
3. Используйте ротацию API-ключей для распределения нагрузки
4. Избегайте блокирующих операций в основном потоке
5. Используйте `TaskQueue` для асинхронной обработки длительных задач

## Контакты для разработчиков

Если у вас возникли вопросы по разработке или вы обнаружили ошибку, пожалуйста, свяжитесь с администратором проекта.
