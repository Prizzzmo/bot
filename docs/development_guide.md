
# Руководство по разработке

## Введение

Данное руководство предназначено для разработчиков, которые хотят участвовать в развитии образовательного Telegram-бота по истории России. Документ описывает архитектуру проекта, основные компоненты, соглашения по коду и процесс разработки.

## Архитектура проекта

Проект реализован на основе модульной архитектуры с четким разделением ответственности:

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Telegram API   │◄───►│    Bot Core     │◄───►│   Gemini API    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                               ▲
                               │
                 ┌─────────────┴─────────────┐
                 │                           │
        ┌────────▼────────┐        ┌────────▼────────┐
        │  CommandHandlers │        │  ContentService │
        └─────────────────┘        └─────────────────┘
```

### Основные компоненты системы:

1. **Bot Core** (`src/bot.py`) - Ядро бота, управляющее взаимодействием с Telegram API
2. **API Client** (`src/api_client.py`) - Клиент для работы с Google Gemini API
3. **Command Handlers** (`src/handlers.py`) - Обработчики команд пользователя
4. **Content Service** (`src/content_service.py`) - Сервис для работы с историческим контентом
5. **Conversation Service** (`src/conversation_service.py`) - Сервис для обработки бесед с пользователем
6. **UI Manager** (`src/ui_manager.py`) - Компонент для управления пользовательским интерфейсом
7. **Analytics Service** (`src/analytics.py`) - Сервис для сбора и анализа статистики
8. **History Map** (`src/history_map.py`) - Сервис для работы с историческими картами
9. **Logger** (`src/logger.py`) - Система логирования

## Соглашения по коду

### Структура файлов

- `src/` - исходный код проекта
- `docs/` - документация
- `tests/` - тесты
- `history_db_generator/` - генератор базы данных исторических событий
- `logs/` - логи работы бота
- `backups/` - резервные копии данных

### Стиль кода

1. **Именование:**
   - Классы: `CamelCase` (например, `APIClient`)
   - Функции и методы: `snake_case` (например, `get_historical_info`)
   - Константы: `UPPER_CASE` (например, `MAX_RETRY_COUNT`)

2. **Документирование:**
   - Каждый класс и метод должен иметь docstring в формате Google Style
   - Комментарии должны объяснять "почему", а не "что"

3. **Обработка ошибок:**
   - Используйте конструкции try-except для обработки исключений
   - Логируйте все исключения с достаточным контекстом

## База данных исторических событий

### Структура данных

База данных исторических событий хранится в формате JSON и содержит следующие поля:
- `name` - название исторического события
- `description` - подробное описание события
- `created_at` - время создания записи
- `updated_at` - время последнего обновления записи

### Обновление базы данных

Для обновления базы данных используется скрипт `run_gemini_generator.py`, который:
1. Инициализирует необходимые директории
2. Проверяет доступность API ключей Gemini
3. Генерирует список исторических тем России
4. Для каждой темы собирает детальную информацию о событиях
5. Сохраняет результаты в JSON файл

## Процесс разработки

### Настройка окружения разработки

1. Клонируйте репозиторий
2. Установите зависимости из `requirements.txt`
3. Создайте файл `.env` с необходимыми API ключами (см. `.env.example`)

### Запуск бота для разработки

```bash
python main.py
```

Для запуска веб-интерфейса:

```bash
python run_webapp.py
```

### Тестирование

Запуск всех тестов:

```bash
python -m pytest tests/
```

Запуск конкретного теста:

```bash
python -m pytest tests/test_api_client.py
```

### Обновление документации

При внесении изменений в код, убедитесь что вы также обновили соответствующую документацию.

## Интеграция с Gemini API

Проект использует Google Gemini API для генерации контента. API клиент (`src/api_client.py`) предоставляет следующие основные методы:

- `call_api()` - базовый метод для вызова Gemini API
- `ask_grok()` - упрощенный метод для получения текстового ответа
- `validate_historical_topic()` - проверка, относится ли тема к истории России
- `get_historical_info()` - получение информации по исторической теме
- `generate_historical_test()` - генерация теста по исторической теме

## Кэширование

Для оптимизации запросов к API используется система кэширования (`src/api_cache.py`). Основные функции:

- Кэширование запросов к Gemini API
- Управление временем жизни кэша (TTL)
- Очистка устаревших записей кэша

## Система логирования

Проект использует модульную систему логирования (`src/logger.py`), которая:

- Записывает логи в файл и консоль
- Поддерживает разные уровни логирования
- Сохраняет контекст ошибок для отладки

## Рекомендации по разработке новых функций

1. **Создание новой команды:**
   - Добавьте обработчик в `handlers.py`
   - Зарегистрируйте команду в диспетчере команд в `bot.py`

2. **Расширение исторической базы данных:**
   - Модифицируйте генератор в `history_db_generator/generator.py`
   - Запустите обновление базы через `run_gemini_generator.py`

3. **Добавление интеграции с новым API:**
   - Создайте новый клиент в стиле `api_client.py`
   - Зарегистрируйте клиент в `service_container.py`

## Резервное копирование и восстановление данных

Система автоматически создает резервные копии данных в директории `backups/`. Для ручного создания резервной копии используйте:

```bash
python data_migration.py --backup
```

Для восстановления из резервной копии:

```bash
python data_migration.py --restore <path_to_backup>
```

## Мониторинг и аналитика

Система собирает аналитические данные о работе бота, которые доступны через:

1. Логи в директории `logs/`
2. Веб-интерфейс аналитики (если запущен через `run_webapp.py`)

## Обработка API-ключей

Для безопасной работы с API-ключами:

1. Не храните ключи в коде
2. Используйте переменные окружения или отдельный конфигурационный файл
3. Не включайте файлы с ключами в систему контроля версий
